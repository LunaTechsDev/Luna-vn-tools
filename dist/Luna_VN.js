/** ============================================================================
 *
 *  Luna_VN.js
 * 
 *  Build Date: 11/7/2020
 * 
 *  Made with LunaTea -- Haxe
 *
 * =============================================================================
*/
// Generated by Haxe 4.1.3
/*:
@author LunaTechs - Kino
@plugindesc A plugin that adds Visual Novel support in MV/MZ <LunaVN>. 

@target MV MZ



@param enableWordWrap
@text Enable Word Wrap
@desc Enables word wrapping support in RPGMakerMV/MZ (true/false)
@default true

@param removeManualLineBreaks
@text Remove Manual Line Breaks
@desc Removes new lines in your text before it is word wrapped(true/false)
@default true

@param msgWindowX
@text Message Window X
@desc The X position of the message window.
@default 100

@param msgWindowY
@text Message Window Y
@desc The Y position of the message window.
@default 400

@param msgWindowWidth
@text Message Window Width
@desc The width of the message window.
@default 600

@param msgWindowHeight
@text Message Window Height
@desc The height of the message window.
@default 250

@param bustWidth
@text Bust Width
@desc Width of the bust on the screen 
@default 125

@param bustHeight
@text Bust Height
@desc Height of the bust on the screen
@default 225

@param bustLimit
@text Bust Limit
@desc The limit of how many busts to show on screen at one time.
If more than the max are used, the oldest bust will be replaced by
the new one.
@default 8

@param breathingAnim
@text Breathing Animation
@desc Whether the busts will have a breathing animation when on screen.
@default true

@command moveBustTo
@text Move Bust To
@desc Allows you to call an event from any map with any event ID

@command setScreenPic
@text Set Screen Picture
@desc Sets the screen picture for your visual novel scene.

@command showScreenPic
@text Show Screen Picture
@desc Shows the screen picture for your visual novel scene.

@command hideScreenPic
@text Hide Screen Picture
@desc Hides the screen picture for your visual novel.

@command setBackdrop
@text Set Backdrop
@desc Sets the new backdrop image for your visual novel scene.

@command showBackdrop
@text Show Backdrop
@desc Shows the backdrop for the Visual Novel scene for the user.

@command hideBackdrop
@text Hide Backdrop
@desc Allows you to hide the backdrop when working with your Visual Novel.

@command showMsgWindow
@text Show Message Window
@desc Shows the message window during a visual novel scene instantly.

@command hideMsgWindow
@text Hide Message Window 
@desc Hides the message window during a visual novel scene instantly.

@command fadeInMsgWindow
@text Fade In Message Window
@desc Fades in the message window during a visual novel scene over time.

@command fadeOutMsgWindow
@text Fade Out Message Window
@desc Fades out the message window during a visual novel scene over time.




@help
==== How To Use ====


MIT License
Copyright (c) 2020 LunaTechsDev
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE
*/

(function ($hx_exports, $global) {
  "use strict";
  var $estr = function () {
      return js_Boot.__string_rec(this, "");
    },
    $hxEnums = $hxEnums || {},
    $_;
  class EReg {
    constructor(r, opt) {
      this.r = new RegExp(r, opt.split("u").join(""));
    }
    match(s) {
      if (this.r.global) {
        this.r.lastIndex = 0;
      }
      this.r.m = this.r.exec(s);
      this.r.s = s;
      return this.r.m != null;
    }
  }

  EReg.__name__ = true;
  class HxOverrides {
    static cca(s, index) {
      let x = s.charCodeAt(index);
      if (x != x) {
        return undefined;
      }
      return x;
    }
    static substr(s, pos, len) {
      if (len == null) {
        len = s.length;
      } else if (len < 0) {
        if (pos == 0) {
          len = s.length + len;
        } else {
          return "";
        }
      }
      return s.substr(pos, len);
    }
    static now() {
      return Date.now();
    }
  }

  HxOverrides.__name__ = true;
  Math.__name__ = true;
  class Std {
    static string(s) {
      return js_Boot.__string_rec(s, "");
    }
  }

  Std.__name__ = true;
  class StringTools {
    static isSpace(s, pos) {
      let c = HxOverrides.cca(s, pos);
      if (!(c > 8 && c < 14)) {
        return c == 32;
      } else {
        return true;
      }
    }
    static ltrim(s) {
      let l = s.length;
      let r = 0;
      while (r < l && StringTools.isSpace(s, r)) ++r;
      if (r > 0) {
        return HxOverrides.substr(s, r, l - r);
      } else {
        return s;
      }
    }
    static rtrim(s) {
      let l = s.length;
      let r = 0;
      while (r < l && StringTools.isSpace(s, l - r - 1)) ++r;
      if (r > 0) {
        return HxOverrides.substr(s, 0, l - r);
      } else {
        return s;
      }
    }
    static trim(s) {
      return StringTools.ltrim(StringTools.rtrim(s));
    }
    static replace(s, sub, by) {
      return s.split(sub).join(by);
    }
  }

  StringTools.__name__ = true;
  class core_Amaryllis {
    static lerp(start, end, amount) {
      return start + (end - start) * amount;
    }
  }

  core_Amaryllis.__name__ = true;
  class EventBuilder {
    constructor() {
      this._currentIndentLvl = 0;
      this._metadata = new haxe_ds_StringMap();
      this._commands = [];
    }
    showText(text, face, faceIndex, background, position) {
      if (position == null) {
        position = 2;
      }
      if (background == null) {
        background = 0;
      }
      if (faceIndex == null) {
        faceIndex = 0;
      }
      if (face == null) {
        face = "";
      }
      this._commands.push({
        code: 101,
        indent: this._currentIndentLvl,
        parameters: [face, faceIndex, background, position],
      });
      this._commands.push({
        code: 401,
        indent: this._currentIndentLvl,
        parameters: [text],
      });
      this._commands.push({
        code: 0,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    controlTimer(startStop, seconds) {
      this._commands.push({
        code: 124,
        indent: this._currentIndentLvl,
        parameters: [startStop, seconds],
      });
    }
    nameInput(actorId, characterLength) {
      this._commands.push({
        code: 303,
        indent: this._currentIndentLvl,
        parameters: [actorId, characterLength],
      });
      return this;
    }
    changeGoldDir(amount) {
      return this.changeGold(0, amount);
    }
    changeGoldVar(variableId) {
      return this.changeGold(1, variableId);
    }
    changeGold(changeType, amount) {
      this._commands.push({
        code: 125,
        indent: this._currentIndentLvl,
        parameters: [this.operationSign(amount), changeType, amount],
      });
      return this;
    }
    changeItemDir(itemId, amount) {
      return this.changeItems(itemId, 0, amount);
    }
    changeItemVar(variableId, amount) {
      return this.changeItems(variableId, 1, amount);
    }
    changeItems(itemVarId, changeType, amount) {
      this._commands.push({
        code: 126,
        indent: this._currentIndentLvl,
        parameters: [itemVarId, this.operationSign(amount), changeType, amount],
      });
      return this;
    }
    changeWepDir(itemId, amount, includeEqp) {
      if (includeEqp == null) {
        includeEqp = false;
      }
      return this.changeWep(itemId, 0, amount, includeEqp);
    }
    changeWepVar(variableId, amount, includeEqp) {
      if (includeEqp == null) {
        includeEqp = false;
      }
      return this.changeWep(variableId, 1, amount, includeEqp);
    }
    changeWep(itemVarId, changeType, amount, includeEqp) {
      if (includeEqp == null) {
        includeEqp = false;
      }
      this._commands.push({
        code: 127,
        indent: this._currentIndentLvl,
        parameters: [
          itemVarId,
          this.operationSign(amount),
          changeType,
          amount,
          includeEqp,
        ],
      });
      return this;
    }
    changeArmorDir(itemId, amount, includeEqp) {
      if (includeEqp == null) {
        includeEqp = false;
      }
      return this.changeArmor(itemId, 0, amount, includeEqp);
    }
    changeArmorVar(variableId, amount, includeEqp) {
      if (includeEqp == null) {
        includeEqp = false;
      }
      return this.changeArmor(variableId, 1, amount, includeEqp);
    }
    changeArmor(itemVarId, changeType, amount, includeEqp) {
      if (includeEqp == null) {
        includeEqp = false;
      }
      this._commands.push({
        code: 128,
        indent: this._currentIndentLvl,
        parameters: [
          itemVarId,
          this.operationSign(amount),
          changeType,
          amount,
          includeEqp,
        ],
      });
      return this;
    }
    addPartyMember(actorId) {
      this.changePartyMember(actorId, 0);
      return this;
    }
    removePartyMember(actorId) {
      this.changePartyMember(actorId, 1);
      return this;
    }
    changePartyMember(actorId, addRemove) {
      this._commands.push({
        code: 129,
        indent: this._currentIndentLvl,
        parameters: [actorId, addRemove],
      });
      return this;
    }
    changeWindowColor(red, green, blue, alpha) {
      if (alpha == null) {
        alpha = 1;
      }
      this._commands.push({
        code: 138,
        indent: this._currentIndentLvl,
        parameters: [red, green, blue, alpha],
      });
      return this;
    }
    eraseEvent() {
      this._commands.push({
        code: 214,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    changePlayerFollowers(onOff) {
      this._commands.push({
        code: 216,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    gatherFollowers() {
      this._commands.push({
        code: 217,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    fadeOutScreen() {
      this._commands.push({
        code: 221,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    fadeInScreen() {
      this._commands.push({
        code: 222,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    wait(frames) {
      this._commands.push({
        code: 230,
        indent: this._currentIndentLvl,
        parameters: [frames],
      });
      return this;
    }
    changeBattleBgm(name, volume, pitch, pan) {
      if (pan == null) {
        pan = 0;
      }
      if (pitch == null) {
        pitch = 100;
      }
      if (volume == null) {
        volume = 100;
      }
      this._commands.push({
        code: 132,
        indent: this._currentIndentLvl,
        parameters: [name, volume, pitch, pan],
      });
      return this;
    }
    changeVictoryMe(name, volume, pitch, pan) {
      if (pan == null) {
        pan = 0;
      }
      if (pitch == null) {
        pitch = 100;
      }
      if (volume == null) {
        volume = 100;
      }
      this._commands.push({
        code: 133,
        indent: this._currentIndentLvl,
        parameters: [name, volume, pitch, pan],
      });
      return this;
    }
    changeDefeatMe(name, volume, pitch, pan) {
      if (pan == null) {
        pan = 0;
      }
      if (pitch == null) {
        pitch = 100;
      }
      if (volume == null) {
        volume = 100;
      }
      this._commands.push({
        code: 139,
        indent: this._currentIndentLvl,
        parameters: [name, volume, pitch, pan],
      });
      return this;
    }
    playBgm(name, volume, pitch, pan) {
      if (pan == null) {
        pan = 0;
      }
      if (pitch == null) {
        pitch = 100;
      }
      if (volume == null) {
        volume = 100;
      }
      this._commands.push({
        code: 241,
        indent: this._currentIndentLvl,
        parameters: [name, volume, pitch, pan],
      });
      return this;
    }
    fadeOutBgm(frames) {
      this._commands.push({
        code: 242,
        indent: this._currentIndentLvl,
        parameters: [frames],
      });
      return this;
    }
    resumeBgm() {
      this._commands.push({
        code: 244,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    saveBgm() {
      this._commands.push({
        code: 243,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    playMe(name, volume, pitch, pan) {
      if (pan == null) {
        pan = 0;
      }
      if (pitch == null) {
        pitch = 100;
      }
      if (volume == null) {
        volume = 100;
      }
      this._commands.push({
        code: 249,
        indent: this._currentIndentLvl,
        parameters: [name, volume, pitch, pan],
      });
      return this;
    }
    playSe(name, volume, pitch, pan) {
      if (pan == null) {
        pan = 0;
      }
      if (pitch == null) {
        pitch = 100;
      }
      if (volume == null) {
        volume = 100;
      }
      this._commands.push({
        code: 250,
        indent: this._currentIndentLvl,
        parameters: [name, volume, pitch, pan],
      });
      return this;
    }
    stopSe() {
      this._commands.push({
        code: 251,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    playMovie(name) {
      this._commands.push({
        code: 261,
        indent: this._currentIndentLvl,
        parameters: [name],
      });
      return this;
    }
    changeMapName(name) {
      this._commands.push({
        code: 281,
        indent: this._currentIndentLvl,
        parameters: [name],
      });
      return this;
    }
    changeTileset(tilesetId) {
      this._commands.push({
        code: 282,
        indent: this._currentIndentLvl,
        parameters: [tilesetId],
      });
      return this;
    }
    changeBattleBack(battleBack1, battleBack2) {
      this._commands.push({
        code: 283,
        indent: this._currentIndentLvl,
        parameters: [battleBack1, battleBack2],
      });
      return this;
    }
    changeTransparency(onOff) {
      this._commands.push({
        code: 211,
        indent: this._currentIndentLvl,
        parameters: [onOff ? 0 : 1],
      });
      return this;
    }
    changeParallax(imageName, loopHorz, scrollHorz, loopVert, scrollVert) {
      if (scrollVert == null) {
        scrollVert = 0;
      }
      if (loopVert == null) {
        loopVert = false;
      }
      if (scrollHorz == null) {
        scrollHorz = 0;
      }
      if (loopHorz == null) {
        loopHorz = false;
      }
      this._commands.push({
        code: 284,
        indent: this._currentIndentLvl,
        parameters: [imageName, loopHorz, loopVert, scrollHorz, scrollVert],
      });
      return this;
    }
    changeName(actorId, name) {
      this._commands.push({
        code: 320,
        indent: this._currentIndentLvl,
        parameters: [actorId, name],
      });
      return this;
    }
    changeNickname(actorId, nickname) {
      this._commands.push({
        code: 324,
        indent: this._currentIndentLvl,
        parameters: [actorId, nickname],
      });
      return this;
    }
    changeProfile(actorId, profileText) {
      this._commands.push({
        code: 325,
        indent: this._currentIndentLvl,
        parameters: [actorId, profileText],
      });
      return this;
    }
    recoverAll(partyActorId) {
      if (partyActorId == null) {
        partyActorId = -1;
      }
      this._commands.push({
        code: 314,
        indent: this._currentIndentLvl,
        parameters: [partyActorId],
      });
      return this;
    }
    enemyRecoverAll(troopEnemyId) {
      if (troopEnemyId == null) {
        troopEnemyId = -1;
      }
      this._commands.push({
        code: 334,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    openSave() {
      this._commands.push({
        code: 352,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    openMenu() {
      this._commands.push({
        code: 351,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    gameOver() {
      this._commands.push({
        code: 353,
        indent: this._currentIndentLvl,
        parameters: [],
      });
    }
    ToTitle() {
      this._commands.push({
        code: 354,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    abortBattle() {
      this._commands.push({
        code: 340,
        indent: this._currentIndentLvl,
        parameters: [],
      });
      return this;
    }
    script(script, indent) {
      this._commands.push({
        code: 355,
        indent: this._currentIndentLvl,
        parameters: [StringTools.trim(script)],
      });
      return this;
    }
    commands() {
      return this._commands;
    }
    metadata() {
      return this._metadata;
    }
    addMetadata(key, value) {
      this._metadata.h[key] = value;
      return this;
    }
    getMetadata(key) {
      return this._metadata.h[key];
    }
    operationSign(value) {
      if (value > 0) {
        return 0;
      } else {
        return 1;
      }
    }
    static create() {
      return new EventBuilder();
    }
  }

  $hx_exports["EventBuilder"] = EventBuilder;
  EventBuilder.__name__ = true;
  class haxe_Log {
    static formatOutput(v, infos) {
      let str = Std.string(v);
      if (infos == null) {
        return str;
      }
      let pstr = infos.fileName + ":" + infos.lineNumber;
      if (infos.customParams != null) {
        let _g = 0;
        let _g1 = infos.customParams;
        while (_g < _g1.length) str += ", " + Std.string(_g1[_g++]);
      }
      return pstr + ": " + str;
    }
    static trace(v, infos) {
      let str = haxe_Log.formatOutput(v, infos);
      if (typeof console != "undefined" && console.log != null) {
        console.log(str);
      }
    }
  }

  haxe_Log.__name__ = true;
  class haxe_ds_StringMap {
    constructor() {
      this.h = Object.create(null);
    }
  }

  haxe_ds_StringMap.__name__ = true;
  class haxe_iterators_ArrayIterator {
    constructor(array) {
      this.current = 0;
      this.array = array;
    }
    hasNext() {
      return this.current < this.array.length;
    }
    next() {
      return this.array[this.current++];
    }
  }

  haxe_iterators_ArrayIterator.__name__ = true;
  class js_Boot {
    static __string_rec(o, s) {
      if (o == null) {
        return "null";
      }
      if (s.length >= 5) {
        return "<...>";
      }
      let t = typeof o;
      if (t == "function" && (o.__name__ || o.__ename__)) {
        t = "object";
      }
      switch (t) {
        case "function":
          return "<function>";
        case "object":
          if (o.__enum__) {
            let e = $hxEnums[o.__enum__];
            let n = e.__constructs__[o._hx_index];
            let con = e[n];
            if (con.__params__) {
              s = s + "\t";
              return (
                n +
                "(" +
                (function ($this) {
                  var $r;
                  let _g = [];
                  {
                    let _g1 = 0;
                    let _g2 = con.__params__;
                    while (true) {
                      if (!(_g1 < _g2.length)) {
                        break;
                      }
                      let p = _g2[_g1];
                      _g1 = _g1 + 1;
                      _g.push(js_Boot.__string_rec(o[p], s));
                    }
                  }
                  $r = _g;
                  return $r;
                })(this).join(",") +
                ")"
              );
            } else {
              return n;
            }
          }
          if (o instanceof Array) {
            let str = "[";
            s += "\t";
            let _g = 0;
            let _g1 = o.length;
            while (_g < _g1) {
              let i = _g++;
              str += (i > 0 ? "," : "") + js_Boot.__string_rec(o[i], s);
            }
            str += "]";
            return str;
          }
          let tostr;
          try {
            tostr = o.toString;
          } catch (_g) {
            return "???";
          }
          if (
            tostr != null &&
            tostr != Object.toString &&
            typeof tostr == "function"
          ) {
            let s2 = o.toString();
            if (s2 != "[object Object]") {
              return s2;
            }
          }
          let str = "{\n";
          s += "\t";
          let hasp = o.hasOwnProperty != null;
          let k = null;
          for (k in o) {
            if (hasp && !o.hasOwnProperty(k)) {
              continue;
            }
            if (
              k == "prototype" ||
              k == "__class__" ||
              k == "__super__" ||
              k == "__interfaces__" ||
              k == "__properties__"
            ) {
              continue;
            }
            if (str.length != 2) {
              str += ", \n";
            }
            str += s + k + " : " + js_Boot.__string_rec(o[k], s);
          }
          s = s.substring(1);
          str += "\n" + s + "}";
          return str;
        case "string":
          return o;
        default:
          return String(o);
      }
    }
  }

  js_Boot.__name__ = true;

  class utils_Fn {
    static proto(obj) {
      return obj.prototype;
    }
    static updateProto(obj, fn) {
      return fn(obj.prototype);
    }
    static updateEntity(obj, fn) {
      return fn(obj);
    }
  }

  utils_Fn.__name__ = true;
  class LunaVN {
    static main() {
      let _g = [];
      let _g1 = 0;
      let _g2 = $plugins;
      while (_g1 < _g2.length) {
        let v = _g2[_g1];
        ++_g1;
        if (new EReg("<LunaVN>", "ig").match(v.description)) {
          _g.push(v);
        }
      }
      let plugin = _g[0];
      let params = plugin.parameters;
      LunaVN.Params = {
        bustLimit: parseInt(params["bustLimit"], 10),
        breathingAnim: params["breathingAnim"].toLowerCase().trim() == "true",
        bustWidth: parseInt(params["bustWidth"], 10),
        bustHeight: parseInt(params["bustHeight"], 10),
        msgWindowX: parseInt(params["msgWindowX"], 10),
        msgWindowY: parseInt(params["msgWindowY"], 10),
        msgWindowWidth: parseInt(params["msgWindowWidth"], 10),
        msgWindowHeight: parseInt(params["msgWindowHeight"], 10),
        enableWordWrap: params["enableWordWrap"].trim() == "true",
        removeManualLineBreaks:
          params["removeManualLineBreaks"].trim() == "true",
      };
      haxe_Log.trace(LunaVN.Params, {
        fileName: "src/visnov/Main.hx",
        lineNumber: 43,
        className: "visnov.Main",
        methodName: "main",
      });

      //=============================================================================
      // Scene_Map
      //=============================================================================
      let _Scene_Map__lvnBusts = Scene_Map.prototype._lvnBusts;
      Scene_Map.prototype._lvnBusts = null;
      let _Scene_Map__lvnListener = Scene_Map.prototype._lvnListener;
      Scene_Map.prototype._lvnListener = null;
      let _Scene_Map__lvnBackdropSprite =
        Scene_Map.prototype._lvnBackdropSprite;
      Scene_Map.prototype._lvnBackdropSprite = null;
      let _Scene_Map__lvnScreenPicSprite =
        Scene_Map.prototype._lvnScreenPicSprite;
      Scene_Map.prototype._lvnScreenPicSprite = null;
      let _Scene_Map__shadowBackdropOpacity =
        Scene_Map.prototype._shadowBackdropOpacity;
      Scene_Map.prototype._shadowBackdropOpacity = null;
      let _Scene_Map__shadowScreenPicOpacity =
        Scene_Map.prototype._shadowScreenPicOpacity;
      Scene_Map.prototype._shadowScreenPicOpacity = null;
      let _Scene_Map_initialize = Scene_Map.prototype.initialize;
      Scene_Map.prototype.initialize = function () {
        _Scene_Map_initialize.call(this);
        this._lvnBusts = [];
        this._lvnListener = new PIXI.utils.EventEmitter();
        this._shadowBackdropOpacity = 0;
        this._shadowScreenPicOpacity = 0;
        this.setupBackdropEvents();
        this.setupScreenPicEvents();
      };
      let _Scene_Map_messageWindowRect = Scene_Map.prototype.messageWindowRect;
      Scene_Map.prototype.messageWindowRect = function () {
        let params = LunaVN.Params;
        return new Rectangle(
          params.msgWindowX,
          params.msgWindowY,
          params.msgWindowWidth,
          params.msgWindowHeight
        );
      };
      let _Scene_Map_createDisplayObjects =
        Scene_Map.prototype.createDisplayObjects;
      Scene_Map.prototype.createDisplayObjects = function () {
        _Scene_Map_createDisplayObjects.call(this);
        this.createLVNBackdropSprite();
        this.createLVNScreenPicSprite();
      };
      let _Scene_Map_createLVNBackdropSprite =
        Scene_Map.prototype.createLVNBackdropSprite;
      Scene_Map.prototype.createLVNBackdropSprite = function () {
        this._lvnBackdropSprite = new Sprite();
        this._lvnBackdropSprite.opacity = 0;
        this.addChildAt(this._lvnBackdropSprite, 1);
      };
      let _Scene_Map_createLVNScreenPicSprite =
        Scene_Map.prototype.createLVNScreenPicSprite;
      Scene_Map.prototype.createLVNScreenPicSprite = function () {
        this._lvnScreenPicSprite = new Sprite();
        this._lvnScreenPicSprite.opacity = 0;
        this.addChildAt(this._lvnScreenPicSprite, 1);
      };
      let _Scene_Map_createAllWindows = Scene_Map.prototype.createAllWindows;
      Scene_Map.prototype.createAllWindows = function () {
        _Scene_Map_createAllWindows.call(this);
        this.addBustsToMessageWindow();
      };
      let _Scene_Map_addBustsToMessageWindow =
        Scene_Map.prototype.addBustsToMessageWindow;
      Scene_Map.prototype.addBustsToMessageWindow = function () {
        let _g = 0;
        let _g1 = LunaVN.Params.bustLimit;
        while (_g < _g1) {
          let index = _g++;
          let bust = new LVNSpriteBust(0, this._messageWindow.height * -1);
          this.setupBustEvents(bust);
          this._lvnBusts.push(bust);
          this._messageWindow.addChild(bust);
        }
      };
      let _Scene_Map_setupBustEvents = Scene_Map.prototype.setupBustEvents;
      Scene_Map.prototype.setupBustEvents = function (bust) {
        let _gthis = this;
        LunaVN.listener.on("showBust", function (id) {
          let bust = _gthis.bust(id);
          bust.show();
        });
        LunaVN.listener.on("hideBust", function (id) {
          let bust = _gthis.bust(id);
          bust.hide();
        });
        LunaVN.listener.on("moveBustTo", function (id, x, y) {
          let bust = _gthis.bust(id);
          bust.moveTo(x, y);
        });
        LunaVN.listener.on("moveBustBy", function (id, x, y) {
          let bust = _gthis.bust(id);
          bust.moveBy(x, y);
        });
        LunaVN.listener.on("fadeToBust", function (id, opacity, duration) {
          let bust = _gthis.bust(id);
          bust.fadeTo(opacity, duration);
        });
        LunaVN.listener.on("fadeByBust", function (id, opacity, duration) {
          let bust = _gthis.bust(id);
          bust.fadeBy(opacity, duration);
        });
        LunaVN.listener.on("scaleTo", function (id, x, y, duration) {
          let bust = _gthis.bust(id);
          bust.scaleTo(x, y, duration);
        });
        LunaVN.listener.on("setBust", function (id, bustSetName) {
          let bust = _gthis.bust(id);
          bust.setBust(bustSetName);
        });
      };
      let _Scene_Map_setupBackdropEvents =
        Scene_Map.prototype.setupBackdropEvents;
      Scene_Map.prototype.setupBackdropEvents = function () {
        let _gthis = this;
        LunaVN.listener.on("setBackdrop", function (imageName) {
          _gthis.setBackdrop(imageName);
        });
        LunaVN.listener.on("showBackdrop", function () {
          _gthis._shadowBackdropOpacity = 255;
        });
        LunaVN.listener.on("hideBackdrop", function () {
          _gthis._shadowBackdropOpacity = 0;
        });
      };
      let _Scene_Map_setupScreenPicEvents =
        Scene_Map.prototype.setupScreenPicEvents;
      Scene_Map.prototype.setupScreenPicEvents = function () {
        let _gthis = this;
        LunaVN.listener.on("setScreenPic", function (imageName) {
          _gthis.setScreenPicture(imageName);
        });
        LunaVN.listener.on("showScreenPic", function () {
          _gthis._shadowScreenPicOpacity = 255;
        });
        LunaVN.listener.on("hideScreenPic", function () {
          _gthis._shadowScreenPicOpacity = 0;
        });
      };
      let _Scene_Map_bust = Scene_Map.prototype.bust;
      Scene_Map.prototype.bust = function (Id) {
        return this._lvnBusts[Id - 1];
      };
      let _Scene_Map_setBackdrop = Scene_Map.prototype.setBackdrop;
      Scene_Map.prototype.setBackdrop = function (imageName) {
        let _gthis = this;
        let bitmap = ImageManager.loadPicture(imageName);
        bitmap.addLoadListener(function (bitmap) {
          _gthis._lvnBackdropSprite.bitmap = bitmap;
          LunaVN.listener.emit("showBackdrop");
        });
      };
      let _Scene_Map_setScreenPicture = Scene_Map.prototype.setScreenPicture;
      Scene_Map.prototype.setScreenPicture = function (imageName) {
        let _gthis = this;
        let bitmap = ImageManager.loadPicture(imageName);
        bitmap.addLoadListener(function (bitmap) {
          _gthis._lvnScreenPicSprite.bitmap = bitmap;
          LunaVN.listener.emit("showScreenPic");
        });
      };
      let _Scene_Map_update = Scene_Map.prototype.update;
      Scene_Map.prototype.update = function () {
        _Scene_Map_update.call(this);
        this.updateBackdrop();
        this.updateScreenSprite();
      };
      let _Scene_Map_updateBackdrop = Scene_Map.prototype.updateBackdrop;
      Scene_Map.prototype.updateBackdrop = function () {
        let shadowOpacity = this._shadowBackdropOpacity;
        let displayObj = this._lvnBackdropSprite;
        let opacityResult = displayObj.opacity;
        if (shadowOpacity != displayObj.opacity) {
          opacityResult = core_Amaryllis.lerp(
            displayObj.opacity,
            shadowOpacity,
            0.045
          );
        }
        if (Math.abs(shadowOpacity - displayObj.opacity) < 0.5) {
          opacityResult = Math.round(opacityResult);
        }
        displayObj.opacity = opacityResult;
      };
      let _Scene_Map_updateScreenSprite =
        Scene_Map.prototype.updateScreenSprite;
      Scene_Map.prototype.updateScreenSprite = function () {
        let shadowOpacity = this._shadowScreenPicOpacity;
        let displayObj = this._lvnScreenPicSprite;
        let opacityResult = displayObj.opacity;
        if (shadowOpacity != displayObj.opacity) {
          opacityResult = core_Amaryllis.lerp(
            displayObj.opacity,
            shadowOpacity,
            0.045
          );
        }
        if (Math.abs(shadowOpacity - displayObj.opacity) < 0.5) {
          opacityResult = Math.round(opacityResult);
        }
        displayObj.opacity = opacityResult;
      };

      //=============================================================================
      // Window_Message
      //=============================================================================
      let _Window_Message__shadowVNWinOpacity =
        Window_Message.prototype._shadowVNWinOpacity;
      Window_Message.prototype._shadowVNWinOpacity = null;
      let _Window_Message__shadowVNFadeComplete =
        Window_Message.prototype._shadowVNFadeComplete;
      Window_Message.prototype._shadowVNFadeComplete = null;
      let _Window_Message_initialize = Window_Message.prototype.initialize;
      Window_Message.prototype.initialize = function (rect) {
        _Window_Message_initialize.call(this, rect);
        this._shadowVNFadeComplete = true;
        this.setupLVNEvents();
      };
      let _Window_Message_setupLVNEvents =
        Window_Message.prototype.setupLVNEvents;
      Window_Message.prototype.setupLVNEvents = function () {
        let _gthis = this;
        LunaVN.listener.on("showMsgWindow", function () {
          _gthis.vnShow();
        });
        LunaVN.listener.on("hideMsgWindow", function () {
          _gthis.vnHide();
        });
        LunaVN.listener.on("fadeInMsgWindow", function () {
          _gthis.vnFadeIn();
        });
        LunaVN.listener.on("fadeOutMsgWindow", function () {
          _gthis.vnFadeOut();
        });
      };
      let _Window_Message_update = Window_Message.prototype.update;
      Window_Message.prototype.update = function () {
        _Window_Message_update.call(this);
        this.updateVNFade();
      };
      let _Window_Message_updateVNFade = Window_Message.prototype.updateVNFade;
      Window_Message.prototype.updateVNFade = function () {
        if (!this._shadowVNFadeComplete) {
          let displayObj = this;
          let shadowOpacity = this._shadowVNWinOpacity;
          let opacityResult = displayObj.opacity;
          if (shadowOpacity != displayObj.opacity) {
            opacityResult = core_Amaryllis.lerp(
              displayObj.opacity,
              shadowOpacity,
              0.045
            );
          }
          if (Math.abs(shadowOpacity - displayObj.opacity) < 0.5) {
            opacityResult = Math.round(opacityResult);
          }
          displayObj.opacity = opacityResult;
          this.contentsOpacity = opacityResult;
        }
      };
      let _Window_Message_startMessage = Window_Message.prototype.startMessage;
      Window_Message.prototype.startMessage = function () {
        _Window_Message_startMessage.call(this);
        if (LunaVN.Params.enableWordWrap) {
          this.vnUpdateTextState(this._textState);
        }
      };
      let _Window_Message_vnUpdateTextState =
        Window_Message.prototype.vnUpdateTextState;
      Window_Message.prototype.vnUpdateTextState = function (
        originalTextState
      ) {
        if (LunaVN.Params.removeManualLineBreaks) {
          originalTextState.text = StringTools.replace(
            originalTextState.text,
            "\n",
            " "
          );
        }
        let textState = originalTextState;
        let length = originalTextState.text.length;
        while (originalTextState.index < length) {
          let currentLines = textState.text
            .substring(0, textState.index + 1)
            .split("\n");
          let latestLine = currentLines[currentLines.length - 1];
          let textUpToIndex = latestLine.substring(0, latestLine.length);
          if (this.textWidth(textUpToIndex) > this.contentsWidth()) {
            let spaceOffset = 1;
            while (
              !StringTools.isSpace(
                textUpToIndex,
                textUpToIndex.length - spaceOffset
              )
            ) {
              ++spaceOffset;
              haxe_Log.trace("Processing Text Offset", {
                fileName: "src/visnov/Window_Message.hx",
                lineNumber: 102,
                className: "visnov.Window_Message",
                methodName: "vnUpdateTextState",
                customParams: [spaceOffset],
              });
            }
            let textWithBreak = textState.text.substring(
              0,
              textState.index - (spaceOffset - 1)
            );
            let textAfterBreak = textState.text.substring(
              textState.index - (spaceOffset - 2),
              textState.text.length
            );
            textState.text = textWithBreak + "\n" + textAfterBreak;
          }
          originalTextState.index++;
        }
        originalTextState.index = 0;
      };
      let _Window_Message_vnFadeIn = Window_Message.prototype.vnFadeIn;
      Window_Message.prototype.vnFadeIn = function () {
        this._shadowVNFadeComplete = false;
        this._shadowVNWinOpacity = 255;
      };
      let _Window_Message_vnFadeOut = Window_Message.prototype.vnFadeOut;
      Window_Message.prototype.vnFadeOut = function () {
        this._shadowVNFadeComplete = false;
        this._shadowVNWinOpacity = 0;
      };
      let _Window_Message_vnShow = Window_Message.prototype.vnShow;
      Window_Message.prototype.vnShow = function () {
        this.show();
      };
      let _Window_Message_vnHide = Window_Message.prototype.vnHide;
      Window_Message.prototype.vnHide = function () {
        this.hide();
      };

      //=============================================================================
      // Game_Interpreter
      //=============================================================================
      let _Game_Interpreter_command681 = Game_Interpreter.prototype.command681;
      Game_Interpreter.prototype.command681 = function () {
        $gameSystem.disableEncounter();
        $gameSystem.disableFormation();
        $gameSystem.disableMenu();
        $gameSystem.disableSave();
        return true;
      };
      let _Game_Interpreter_command682 = Game_Interpreter.prototype.command682;
      Game_Interpreter.prototype.command682 = function () {
        $gameSystem.enableEncounter();
        $gameSystem.enableFormation();
        $gameSystem.enableMenu();
        $gameSystem.enableSave();
        return true;
      };
      let pluginName = plugin.name;
      PluginManager.registerCommand(pluginName, "moveBustTo", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.moveBustTo(params.id, params.x, params.y);
      });
      PluginManager.registerCommand(pluginName, "moveBustBy", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.moveBustBy(params.id, params.x, params.y);
      });
      PluginManager.registerCommand(pluginName, "fadeBustTo", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.fadeBustTo(params.id, params.opacity, params.duration);
      });
      PluginManager.registerCommand(pluginName, "fadeBustBy", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.fadeBustBy(params.id, params.opacity, params.duration);
      });
      PluginManager.registerCommand(pluginName, "scaleBustTo", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.scaleBustTo(params.id, params.x, params.y, params.duration);
      });
      PluginManager.registerCommand(pluginName, "hideBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.hideBust(params.id);
      });
      PluginManager.registerCommand(pluginName, "showBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.showBust(params.id);
      });
      PluginManager.registerCommand(pluginName, "emoteBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.emoteBust(params.id, params.emote);
      });
      PluginManager.registerCommand(pluginName, "animBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.animateBust(params.id, params.animation);
      });
      PluginManager.registerCommand(pluginName, "highlightBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.highlightBust(params.id);
      });
      PluginManager.registerCommand(pluginName, "darkenBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.darkenBust(params.id);
      });
      PluginManager.registerCommand(pluginName, "setBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.setBust(params.id, params.bustSetName);
      });
      PluginManager.registerCommand(pluginName, "setBackdrop", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.setBackdrop(params.imageName);
      });
      PluginManager.registerCommand(pluginName, "showBackdrop", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.showBackdrop();
      });
      PluginManager.registerCommand(pluginName, "hideBackdrop", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.hideBackdrop();
      });
      PluginManager.registerCommand(pluginName, "setScreenPic", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.setScreenPic(params.imageName);
      });
      PluginManager.registerCommand(pluginName, "showScreenPic", function (
        jsonParams
      ) {
        LunaVN.showScreenPic();
      });
      PluginManager.registerCommand(pluginName, "hideScreenPic", function (
        jsonParams
      ) {
        LunaVN.hideScreenPic();
      });
      PluginManager.registerCommand(pluginName, "showMsgWindow", function (
        jsonParams
      ) {
        LunaVN.showMsgWindow();
      });
      PluginManager.registerCommand(pluginName, "hideMsgWindow", function (
        jsonParams
      ) {
        LunaVN.hideMsgWindow();
      });
      PluginManager.registerCommand(pluginName, "fadeInMsgWindow", function (
        jsonParams
      ) {
        LunaVN.fadeInMsgWindow();
      });
      PluginManager.registerCommand(pluginName, "fadeOutMsgWindow", function (
        jsonParams
      ) {
        LunaVN.fadeOutMsgWindow();
      });
    }
    static params() {
      return LunaVN.Params;
    }
    static registerAllPluginCommands(pluginName) {
      PluginManager.registerCommand(pluginName, "moveBustTo", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.moveBustTo(params.id, params.x, params.y);
      });
      PluginManager.registerCommand(pluginName, "moveBustBy", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.moveBustBy(params.id, params.x, params.y);
      });
      PluginManager.registerCommand(pluginName, "fadeBustTo", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.fadeBustTo(params.id, params.opacity, params.duration);
      });
      PluginManager.registerCommand(pluginName, "fadeBustBy", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.fadeBustBy(params.id, params.opacity, params.duration);
      });
      PluginManager.registerCommand(pluginName, "scaleBustTo", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.scaleBustTo(params.id, params.x, params.y, params.duration);
      });
      PluginManager.registerCommand(pluginName, "hideBust", function (
        jsonParams
      ) {
        LunaVN.hideBust(JsonEx.parse(jsonParams).id);
      });
      PluginManager.registerCommand(pluginName, "showBust", function (
        jsonParams
      ) {
        LunaVN.showBust(JsonEx.parse(jsonParams).id);
      });
      PluginManager.registerCommand(pluginName, "emoteBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.emoteBust(params.id, params.emote);
      });
      PluginManager.registerCommand(pluginName, "animBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.animateBust(params.id, params.animation);
      });
      PluginManager.registerCommand(pluginName, "highlightBust", function (
        jsonParams
      ) {
        LunaVN.highlightBust(JsonEx.parse(jsonParams).id);
      });
      PluginManager.registerCommand(pluginName, "darkenBust", function (
        jsonParams
      ) {
        LunaVN.darkenBust(JsonEx.parse(jsonParams).id);
      });
      PluginManager.registerCommand(pluginName, "setBust", function (
        jsonParams
      ) {
        let params = JsonEx.parse(jsonParams);
        LunaVN.setBust(params.id, params.bustSetName);
      });
      PluginManager.registerCommand(pluginName, "setBackdrop", function (
        jsonParams
      ) {
        LunaVN.setBackdrop(JsonEx.parse(jsonParams).imageName);
      });
      PluginManager.registerCommand(pluginName, "showBackdrop", function (
        jsonParams
      ) {
        JsonEx.parse(jsonParams);
        LunaVN.showBackdrop();
      });
      PluginManager.registerCommand(pluginName, "hideBackdrop", function (
        jsonParams
      ) {
        JsonEx.parse(jsonParams);
        LunaVN.hideBackdrop();
      });
      PluginManager.registerCommand(pluginName, "setScreenPic", function (
        jsonParams
      ) {
        LunaVN.setScreenPic(JsonEx.parse(jsonParams).imageName);
      });
      PluginManager.registerCommand(pluginName, "showScreenPic", function (
        jsonParams
      ) {
        LunaVN.showScreenPic();
      });
      PluginManager.registerCommand(pluginName, "hideScreenPic", function (
        jsonParams
      ) {
        LunaVN.hideScreenPic();
      });
      PluginManager.registerCommand(pluginName, "showMsgWindow", function (
        jsonParams
      ) {
        LunaVN.showMsgWindow();
      });
      PluginManager.registerCommand(pluginName, "hideMsgWindow", function (
        jsonParams
      ) {
        LunaVN.hideMsgWindow();
      });
      PluginManager.registerCommand(pluginName, "fadeInMsgWindow", function (
        jsonParams
      ) {
        LunaVN.fadeInMsgWindow();
      });
      PluginManager.registerCommand(pluginName, "fadeOutMsgWindow", function (
        jsonParams
      ) {
        LunaVN.fadeOutMsgWindow();
      });
    }
    static moveBustTo(id, x, y) {
      LunaVN.listener.emit("moveBustTo", id, x, y);
    }
    static moveBustBy(id, x, y) {
      LunaVN.listener.emit("moveBustBy", id, x, y);
    }
    static hideBust(id) {
      LunaVN.listener.emit("hideBust", id);
    }
    static showBust(id) {
      LunaVN.listener.emit("showBust", id);
    }
    static fadeBustTo(Id, opacity, duration) {
      LunaVN.listener.emit("fadeToBust", Id, opacity, duration);
    }
    static fadeBustBy(id, opacity, duration) {
      LunaVN.listener.emit("fadeByBust", id, opacity, duration);
    }
    static scaleBustTo(id, x, y, duration) {
      LunaVN.listener.emit("scaleTo", x, y, duration);
    }
    static emoteBust(id, emote) {
      LunaVN.listener.emit("emoteBust", id, emote);
    }
    static animateBust(id, animation) {
      LunaVN.listener.emit("animBust", id, animation);
    }
    static highlightBust(id) {
      LunaVN.listener.emit("highlightBust", id);
    }
    static darkenBust(id) {
      LunaVN.listener.emit("darkenBust", id);
    }
    static setBust(id, bustSetName) {
      LunaVN.listener.emit("setBust", id, bustSetName);
    }
    static setBackdrop(imageName) {
      LunaVN.listener.emit("setBackdrop", imageName);
    }
    static showBackdrop() {
      LunaVN.listener.emit("showBackdrop");
    }
    static hideBackdrop() {
      LunaVN.listener.emit("hideBackdrop");
    }
    static setScreenPic(imageName) {
      LunaVN.listener.emit("setScreenPic", imageName);
    }
    static showScreenPic() {
      LunaVN.listener.emit("showScreenPic");
    }
    static hideScreenPic() {
      LunaVN.listener.emit("hideScreenPic");
    }
    static showMsgWindow() {
      LunaVN.listener.emit("showMsgWindow");
    }
    static hideMsgWindow() {
      LunaVN.listener.emit("hideMsgWindow");
    }
    static fadeInMsgWindow() {
      LunaVN.listener.emit("fadeInMsgWindow");
    }
    static fadeOutMsgWindow() {
      LunaVN.listener.emit("fadeOutMsgWindow");
    }
  }

  $hx_exports["LunaVN"] = LunaVN;
  LunaVN.__name__ = true;
  class visnov_Scene_$Map extends Scene_Map {
    constructor() {
      super();
    }
    initialize() {
      _Scene_Map_initialize.call(this);
      this._lvnBusts = [];
      this._lvnListener = new PIXI.utils.EventEmitter();
      this._shadowBackdropOpacity = 0;
      this._shadowScreenPicOpacity = 0;
      this.setupBackdropEvents();
      this.setupScreenPicEvents();
    }
    createDisplayObjects() {
      _Scene_Map_createDisplayObjects.call(this);
      this.createLVNBackdropSprite();
      this.createLVNScreenPicSprite();
    }
    createLVNBackdropSprite() {
      this._lvnBackdropSprite = new Sprite();
      this._lvnBackdropSprite.opacity = 0;
      this.addChildAt(this._lvnBackdropSprite, 1);
    }
    createLVNScreenPicSprite() {
      this._lvnScreenPicSprite = new Sprite();
      this._lvnScreenPicSprite.opacity = 0;
      this.addChildAt(this._lvnScreenPicSprite, 1);
    }
    createAllWindows() {
      _Scene_Map_createAllWindows.call(this);
      this.addBustsToMessageWindow();
    }
    addBustsToMessageWindow() {
      let _g = 0;
      let _g1 = LunaVN.Params.bustLimit;
      while (_g < _g1) {
        ++_g;
        let bust = new LVNSpriteBust(0, this._messageWindow.height * -1);
        this.setupBustEvents(bust);
        this._lvnBusts.push(bust);
        this._messageWindow.addChild(bust);
      }
    }
    setupBustEvents(bust) {
      let _gthis = this;
      LunaVN.listener.on("showBust", function (id) {
        _gthis.bust(id).show();
      });
      LunaVN.listener.on("hideBust", function (id) {
        _gthis.bust(id).hide();
      });
      LunaVN.listener.on("moveBustTo", function (id, x, y) {
        _gthis.bust(id).moveTo(x, y);
      });
      LunaVN.listener.on("moveBustBy", function (id, x, y) {
        _gthis.bust(id).moveBy(x, y);
      });
      LunaVN.listener.on("fadeToBust", function (id, opacity, duration) {
        _gthis.bust(id).fadeTo(opacity, duration);
      });
      LunaVN.listener.on("fadeByBust", function (id, opacity, duration) {
        _gthis.bust(id).fadeBy(opacity, duration);
      });
      LunaVN.listener.on("scaleTo", function (id, x, y, duration) {
        _gthis.bust(id).scaleTo(x, y, duration);
      });
      LunaVN.listener.on("setBust", function (id, bustSetName) {
        _gthis.bust(id).setBust(bustSetName);
      });
    }
    setupBackdropEvents() {
      let _gthis = this;
      LunaVN.listener.on("setBackdrop", function (imageName) {
        _gthis.setBackdrop(imageName);
      });
      LunaVN.listener.on("showBackdrop", function () {
        _gthis._shadowBackdropOpacity = 255;
      });
      LunaVN.listener.on("hideBackdrop", function () {
        _gthis._shadowBackdropOpacity = 0;
      });
    }
    setupScreenPicEvents() {
      let _gthis = this;
      LunaVN.listener.on("setScreenPic", function (imageName) {
        _gthis.setScreenPicture(imageName);
      });
      LunaVN.listener.on("showScreenPic", function () {
        _gthis._shadowScreenPicOpacity = 255;
      });
      LunaVN.listener.on("hideScreenPic", function () {
        _gthis._shadowScreenPicOpacity = 0;
      });
    }
    bust(Id) {
      return this._lvnBusts[Id - 1];
    }
    setBackdrop(imageName) {
      let _gthis = this;
      ImageManager.loadPicture(imageName).addLoadListener(function (bitmap) {
        _gthis._lvnBackdropSprite.bitmap = bitmap;
        LunaVN.listener.emit("showBackdrop");
      });
    }
    setScreenPicture(imageName) {
      let _gthis = this;
      ImageManager.loadPicture(imageName).addLoadListener(function (bitmap) {
        _gthis._lvnScreenPicSprite.bitmap = bitmap;
        LunaVN.listener.emit("showScreenPic");
      });
    }
    updateBackdrop() {
      let shadowOpacity = this._shadowBackdropOpacity;
      let displayObj = this._lvnBackdropSprite;
      let opacityResult = displayObj.opacity;
      if (shadowOpacity != displayObj.opacity) {
        opacityResult = core_Amaryllis.lerp(
          displayObj.opacity,
          shadowOpacity,
          0.045
        );
      }
      if (Math.abs(shadowOpacity - displayObj.opacity) < 0.5) {
        opacityResult = Math.round(opacityResult);
      }
      displayObj.opacity = opacityResult;
    }
    updateScreenSprite() {
      let shadowOpacity = this._shadowScreenPicOpacity;
      let displayObj = this._lvnScreenPicSprite;
      let opacityResult = displayObj.opacity;
      if (shadowOpacity != displayObj.opacity) {
        opacityResult = core_Amaryllis.lerp(
          displayObj.opacity,
          shadowOpacity,
          0.045
        );
      }
      if (Math.abs(shadowOpacity - displayObj.opacity) < 0.5) {
        opacityResult = Math.round(opacityResult);
      }
      displayObj.opacity = opacityResult;
    }
  }

  visnov_Scene_$Map.__name__ = true;
  class visnov_Window_$Message extends Window_Message {
    constructor(rect) {
      super(rect);
    }
    initialize(rect) {
      _Window_Message_initialize.call(this, rect);
      this._shadowVNFadeComplete = true;
      this.setupLVNEvents();
    }
    setupLVNEvents() {
      let _gthis = this;
      LunaVN.listener.on("showMsgWindow", function () {
        _gthis.vnShow();
      });
      LunaVN.listener.on("hideMsgWindow", function () {
        _gthis.vnHide();
      });
      LunaVN.listener.on("fadeInMsgWindow", function () {
        _gthis.vnFadeIn();
      });
      LunaVN.listener.on("fadeOutMsgWindow", function () {
        _gthis.vnFadeOut();
      });
    }
    update() {
      _Window_Message_update.call(this);
      this.updateVNFade();
    }
    updateVNFade() {
      if (!this._shadowVNFadeComplete) {
        let displayObj = this;
        let shadowOpacity = this._shadowVNWinOpacity;
        let opacityResult = displayObj.opacity;
        if (shadowOpacity != displayObj.opacity) {
          opacityResult = core_Amaryllis.lerp(
            displayObj.opacity,
            shadowOpacity,
            0.045
          );
        }
        if (Math.abs(shadowOpacity - displayObj.opacity) < 0.5) {
          opacityResult = Math.round(opacityResult);
        }
        displayObj.opacity = opacityResult;
        this.contentsOpacity = opacityResult;
      }
    }
    startMessage() {
      _Window_Message_startMessage.call(this);
      if (LunaVN.Params.enableWordWrap) {
        this.vnUpdateTextState(this._textState);
      }
    }
    vnUpdateTextState(originalTextState) {
      if (LunaVN.Params.removeManualLineBreaks) {
        originalTextState.text = StringTools.replace(
          originalTextState.text,
          "\n",
          " "
        );
      }
      let textState = originalTextState;
      let length = originalTextState.text.length;
      while (originalTextState.index < length) {
        let currentLines = textState.text
          .substring(0, textState.index + 1)
          .split("\n");
        let latestLine = currentLines[currentLines.length - 1];
        let textUpToIndex = latestLine.substring(0, latestLine.length);
        if (this.textWidth(textUpToIndex) > this.contentsWidth()) {
          let spaceOffset = 1;
          while (
            !StringTools.isSpace(
              textUpToIndex,
              textUpToIndex.length - spaceOffset
            )
          ) {
            ++spaceOffset;
            haxe_Log.trace("Processing Text Offset", {
              fileName: "src/visnov/Window_Message.hx",
              lineNumber: 102,
              className: "visnov.Window_Message",
              methodName: "vnUpdateTextState",
              customParams: [spaceOffset],
            });
          }
          let textWithBreak = textState.text.substring(
            0,
            textState.index - (spaceOffset - 1)
          );
          let textAfterBreak = textState.text.substring(
            textState.index - (spaceOffset - 2),
            textState.text.length
          );
          textState.text = textWithBreak + "\n" + textAfterBreak;
        }
        originalTextState.index++;
      }
      originalTextState.index = 0;
    }
    vnFadeIn() {
      this._shadowVNFadeComplete = false;
      this._shadowVNWinOpacity = 255;
    }
    vnFadeOut() {
      this._shadowVNFadeComplete = false;
      this._shadowVNWinOpacity = 0;
    }
    vnShow() {
      this.show();
    }
    vnHide() {
      this.hide();
    }
  }

  visnov_Window_$Message.__name__ = true;
  var visnov_sprites_MoveType = ($hxEnums["visnov.sprites.MoveType"] = {
    __ename__: true,
    __constructs__: ["Linear"],
    Linear: {
      _hx_index: 0,
      __enum__: "visnov.sprites.MoveType",
      toString: $estr,
    },
  });

  class LVNSpriteBust extends Sprite {
    constructor(x, y, bitmap) {
      super();
      if (bitmap != null) {
        this.bitmap = bitmap;
        this.handleLoading(this.bitmap);
      }
      this.x = x;
      this.y = y;
      this._moveWait = 30;
    }
    setBust(bustSetName) {
      this.handleLoading(ImageManager.loadPicture(bustSetName, 0));
    }
    handleLoading(bitmap) {
      let _gthis = this;
      bitmap.addLoadListener(function (bitmap) {
        _gthis.bitmap = new Bitmap(
          LunaVN.Params.bustWidth,
          LunaVN.Params.bustHeight
        );
        _gthis.bitmap.blt(
          bitmap,
          0,
          0,
          bitmap.width,
          bitmap.height,
          0,
          0,
          LunaVN.Params.bustWidth,
          LunaVN.Params.bustHeight
        );
        haxe_Log.trace("Loaded Sprite Bust", {
          fileName: "src/visnov/sprites/SpriteBust.hx",
          lineNumber: 63,
          className: "visnov.sprites.SpriteBust",
          methodName: "handleLoading",
        });
        _gthis.show();
      });
    }
    initialize(bitmap) {
      super.initialize(bitmap);
      this._fadeDuration = 0;
      this._shadowOpacity = this.opacity;
      this._shadowX = this.x;
      this._shadowY = this.y;
      this._shadowScale = this.scale;
      this._defaultMoveType = visnov_sprites_MoveType.Linear;
    }
    moveTo(x, y) {
      this._shadowX = x;
      if (y != null) {
        this._shadowY = y;
      }
      this._moveWait = 30;
      haxe_Log.trace("Starting Move", {
        fileName: "src/visnov/sprites/SpriteBust.hx",
        lineNumber: 90,
        className: "visnov.sprites.SpriteBust",
        methodName: "moveTo",
        customParams: [this._moveWait],
      });
    }
    moveBy(x, y) {
      this._shadowX += x;
      if (y != null) {
        this._shadowY += y;
      }
      this._moveWait = 30;
    }
    fadeTo(opacity, duration) {
      if (duration == null) {
        duration = 30;
      }
      this._shadowOpacity = opacity;
      this._fadeDuration = duration;
    }
    fadeBy(opacity, duration) {
      if (duration == null) {
        duration = 30;
      }
      this._shadowOpacity += opacity;
      this._fadeDuration = duration;
    }
    scaleTo(x, y, duration) {
      if (duration == null) {
        duration = 30;
      }
      this.scale.set(x, y);
      this._scaleDuration = duration;
    }
    update() {
      super.update();
      this.updateFade();
      this.updateScaling();
      if (this._moveWait == 0) {
        this.updateMovement();
      }
      if (this._moveWait > 0) {
        this._moveWait--;
      }
    }
    updateFade() {
      let shadowOpacity = this._shadowOpacity;
      let displayObj = this;
      let opacityResult = displayObj.opacity;
      if (shadowOpacity != displayObj.opacity) {
        opacityResult = core_Amaryllis.lerp(
          displayObj.opacity,
          shadowOpacity,
          0.045
        );
      }
      if (Math.abs(shadowOpacity - displayObj.opacity) < 0.5) {
        opacityResult = Math.round(opacityResult);
      }
      displayObj.opacity = opacityResult;
    }
    updateScaling() {}
    updateMovement() {
      let xResult = this.x;
      let yResult = this.y;
      if (this._shadowX != this.x) {
        xResult = core_Amaryllis.lerp(this.x, this._shadowX, 0.025);
      }
      if (this._shadowY != this.y) {
        yResult = core_Amaryllis.lerp(this.y, this._shadowY, 0.025);
      }
      if (this._shadowX == this.x && this._shadowY == this.y) {
        this._moveWait = -1;
        haxe_Log.trace("Disable Moving", {
          fileName: "src/visnov/sprites/SpriteBust.hx",
          lineNumber: 154,
          className: "visnov.sprites.SpriteBust",
          methodName: "updateMovement",
        });
      }
      if (Math.abs(this._shadowX - this.x) < 0.5) {
        xResult = Math.round(xResult);
      }
      if (Math.abs(this._shadowY - this.y) < 0.5) {
        yResult = Math.round(yResult);
      }
      this.move(xResult, yResult);
      haxe_Log.trace("Moving", {
        fileName: "src/visnov/sprites/SpriteBust.hx",
        lineNumber: 167,
        className: "visnov.sprites.SpriteBust",
        methodName: "updateMovement",
        customParams: [this.x, this.y],
      });
      this._refresh();
    }
    oscillateSize() {
      let xYResult = Math.abs(Math.sin(new Date().getTime() / 1000) / 2.0);
      this.scale.x = 1 - xYResult;
      this.scale.y = 1 - xYResult;
    }
  }

  $hx_exports["LVNSpriteBust"] = LVNSpriteBust;
  LVNSpriteBust.__name__ = true;
  if (
    typeof performance != "undefined"
      ? typeof performance.now == "function"
      : false
  ) {
    HxOverrides.now = performance.now.bind(performance);
  }
  String.__name__ = true;
  Array.__name__ = true;
  Date.__name__ = "Date";
  js_Boot.__toStr = {}.toString;
  LunaVN.listener = new PIXI.utils.EventEmitter();
  LunaVN.EBuilder = EventBuilder;
  LunaVN.main();
})(
  typeof exports != "undefined"
    ? exports
    : typeof window != "undefined"
    ? window
    : typeof self != "undefined"
    ? self
    : this,
  {}
);
